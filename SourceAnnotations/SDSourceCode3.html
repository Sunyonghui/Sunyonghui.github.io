<!doctype html>




<html class="theme-next mist" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


 




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


 

  <meta name="google-site-verification" content="tJ1b_5K4s886Dj_mMP2tyEHgak2WOqILA5ZEH-a61GA" />



  <meta name="baidu-site-verification" content="8pzR3AIELM" />


 







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="æºç ," />





  <link rel="alternate" href="/atom.xml" title="å››æ—¶äº”å‘³ï¼Œå†·æš–è‡ªçŸ¥" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/logo.jpg?v=5.1.1" />






<meta name="description" content="Write in the first SDWebImageDownloaderå®Œæˆäº†å¯¹ç½‘ç»œå›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½å·¥ä½œï¼Œå‡†ç¡®è¯´è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½(å·¥å…·ç±»)ï¼Œè€ŒçœŸæ­£çš„ç½‘ç»œè¯·æ±‚æ˜¯åœ¨ç»§æ‰¿äºNSOperationçš„SDWebImageDownloaderOperationç±»å®ç°çš„ã€‚ æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»ã€SDWebImageDownloader æ–‡ä»¶ä¸‹è½½ã€‘å­¦ä¹ æ€»ç»“ã€‚åœ¨ã€Œæ—¶é—´ &amp;amp; çŸ¥è¯† ã€æœ‰é™å†…ï¼Œæ€»ç»“çš„æ–‡ç« éš¾å…æœ‰">
<meta name="keywords" content="æºç ">
<meta property="og:type" content="article">
<meta property="og:title" content="SDWebImageæºç 3â€”SDWebImageDownloader">
<meta property="og:url" content="https://sunyonghui.github.io/SourceAnnotations/SDSourceCode3.html">
<meta property="og:site_name" content="å››æ—¶äº”å‘³ï¼Œå†·æš–è‡ªçŸ¥">
<meta property="og:description" content="Write in the first SDWebImageDownloaderå®Œæˆäº†å¯¹ç½‘ç»œå›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½å·¥ä½œï¼Œå‡†ç¡®è¯´è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½(å·¥å…·ç±»)ï¼Œè€ŒçœŸæ­£çš„ç½‘ç»œè¯·æ±‚æ˜¯åœ¨ç»§æ‰¿äºNSOperationçš„SDWebImageDownloaderOperationç±»å®ç°çš„ã€‚ æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»ã€SDWebImageDownloader æ–‡ä»¶ä¸‹è½½ã€‘å­¦ä¹ æ€»ç»“ã€‚åœ¨ã€Œæ—¶é—´ &amp;amp; çŸ¥è¯† ã€æœ‰é™å†…ï¼Œæ€»ç»“çš„æ–‡ç« éš¾å…æœ‰">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2230763-91fc060201939e25.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2230763-12d6dbccc3bbf70c.gif?imageMogr2/auto-orient/strip">
<meta property="og:updated_time" content="2017-07-15T01:33:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SDWebImageæºç 3â€”SDWebImageDownloader">
<meta name="twitter:description" content="Write in the first SDWebImageDownloaderå®Œæˆäº†å¯¹ç½‘ç»œå›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½å·¥ä½œï¼Œå‡†ç¡®è¯´è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½(å·¥å…·ç±»)ï¼Œè€ŒçœŸæ­£çš„ç½‘ç»œè¯·æ±‚æ˜¯åœ¨ç»§æ‰¿äºNSOperationçš„SDWebImageDownloaderOperationç±»å®ç°çš„ã€‚ æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»ã€SDWebImageDownloader æ–‡ä»¶ä¸‹è½½ã€‘å­¦ä¹ æ€»ç»“ã€‚åœ¨ã€Œæ—¶é—´ &amp;amp; çŸ¥è¯† ã€æœ‰é™å†…ï¼Œæ€»ç»“çš„æ–‡ç« éš¾å…æœ‰">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/2230763-91fc060201939e25.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":true,"scrollpercent":true},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: 'undefined',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



<script>
    (function(){
        if(''){
            if (prompt('è¯·è¾“å…¥æ–‡ç« å¯†ç ') !== ''){
                alert('å¯†ç é”™è¯¯ï¼');
                history.back();
            }
        }
    })();
</script>







  <link rel="canonical" href="https://sunyonghui.github.io/SourceAnnotations/SDSourceCode3.html"/>





  <title> SDWebImageæºç 3â€”SDWebImageDownloader | å››æ—¶äº”å‘³ï¼Œå†·æš–è‡ªçŸ¥ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">å››æ—¶äº”å‘³ï¼Œå†·æš–è‡ªçŸ¥</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-commenting"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>










 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://sunyonghui.github.io/SourceAnnotations/SDSourceCode3.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="æ— å‘³sh">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="å››æ—¶äº”å‘³ï¼Œå†·æš–è‡ªçŸ¥">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="å››æ—¶äº”å‘³ï¼Œå†·æš–è‡ªçŸ¥" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                SDWebImageæºç 3â€”SDWebImageDownloader
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-17T00:00:00+08:00">
                2016-09-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç /" itemprop="url" rel="index">
                    <span itemprop="name">æºç </span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/SourceAnnotations/SDSourceCode3.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/SourceAnnotations/SDSourceCode3.html" class="leancloud_visitors" data-flag-title="SDWebImageæºç 3â€”SDWebImageDownloader">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Reading </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">




	<noscript>æ·»åŠ å­—æ•°ç»Ÿè®¡å’Œé˜…è¯»æ—¶é•¿</noscript>

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                  
                    <span class="post-meta-item-text">Count</span>
		    &nbsp;<i class="fa fa-heartbeat"></i>&nbsp;
                  
                    <span title="post.wordcount" }}">
                      3,907 W
                    </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                  
                    <span class="post-meta-item-text">Time</span>
		    &nbsp;<i class="fa fa-heartbeat"></i>&nbsp;
                  
                    <span title="post.min2read" }}">
                      17 M
                    </span>
              

	<noscript>æ·»åŠ å­—æ•°ç»Ÿè®¡å’Œé˜…è¯»æ—¶é•¿</noscript>



            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="Write-in-the-first"><a href="#Write-in-the-first" class="headerlink" title="Write in the first"></a>Write in the first</h4><hr>
<p><strong><code>SDWebImageDownloader</code></strong>å®Œæˆäº†å¯¹ç½‘ç»œå›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½å·¥ä½œï¼Œå‡†ç¡®è¯´è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½(å·¥å…·ç±»)ï¼Œè€ŒçœŸæ­£çš„ç½‘ç»œè¯·æ±‚æ˜¯åœ¨ç»§æ‰¿äº<code>NSOperation</code>çš„<code>SDWebImageDownloaderOperation</code>ç±»å®ç°çš„ã€‚</p>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»ã€SDWebImageDownloader æ–‡ä»¶ä¸‹è½½ã€‘å­¦ä¹ æ€»ç»“ã€‚<br>åœ¨ã€Œæ—¶é—´ &amp; çŸ¥è¯† ã€æœ‰é™å†…ï¼Œæ€»ç»“çš„æ–‡ç« éš¾å…æœ‰ã€Œæœªå…¨ã€ä¸è¶³ ã€çš„åœ°æ–¹ï¼Œè¿˜æœ›å„ä½å¥½å‹æŒ‡å‡ºï¼Œä»¥æé«˜æ–‡ç« è´¨é‡ğŸ”ç™½å¼€æ°´lnã€‚</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2230763-91fc060201939e25.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="SDWebImageå†…éƒ¨ç»“æ„.png"></p>
<p><code>SDWebImageDownloader</code>çš„å¤´æ–‡ä»¶å†…å®¹æ¯”è¾ƒå°‘ï¼Œä¸»è¦æ˜¯å®šä¹‰äº†ä¸€äº›åŸºæœ¬å‚æ•°å¦‚ä¸‹è½½ä¼˜å…ˆçº§ç­–ç•¥ã€æœ€å¤§å¹¶å‘æ•°ã€è¶…æ—¶æ—¶é—´ç­‰ï¼Œæ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p>
<h4 id="SDWebImageDownloader-ä¸­æ ¸å¿ƒæ–¹æ³•ï¼šä¸‹è½½å›¾ç‰‡çš„æ“ä½œ"><a href="#SDWebImageDownloader-ä¸­æ ¸å¿ƒæ–¹æ³•ï¼šä¸‹è½½å›¾ç‰‡çš„æ“ä½œ" class="headerlink" title="SDWebImageDownloader ä¸­æ ¸å¿ƒæ–¹æ³•ï¼šä¸‹è½½å›¾ç‰‡çš„æ“ä½œ"></a>SDWebImageDownloader ä¸­æ ¸å¿ƒæ–¹æ³•ï¼šä¸‹è½½å›¾ç‰‡çš„æ“ä½œ</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * ä½¿ç”¨ç»™å®šçš„ URL åˆ›å»º SDWebImageDownloader å¼‚æ­¥ä¸‹è½½å™¨å®ä¾‹</div><div class="line"> * å›¾åƒä¸‹è½½å®Œæˆæˆ–è€…å‡ºç°é”™è¯¯æ—¶ä¼šé€šçŸ¥ä»£ç†</div><div class="line"> */</div><div class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="built_in">NSURL</span> *)url</div><div class="line">                            options:(SDWebImageDownloaderOptions)options</div><div class="line">                       progress:(SDWebImageDownloaderProgressBlock)progressBlock                                                                                    </div><div class="line">                    completed:(SDWebImageDownloaderCompletedBlock)completedBlock;</div></pre></td></tr></table></figure>
<p>åœ¨çœ‹è¿™ä¸ªæ–¹æ³•ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹å¦å¤–ä¸€ä¸ªæ–¹æ³•:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å¤„ç†SDWebImageDownloaderProgressBlockå’ŒSDWebImageDownloaderCompletedBlock</span></div><div class="line"><span class="comment">//ä¸»è¦å¤„ç†å¯¹è±¡ä¸ºself.URLCallbackså­—å…¸</span></div><div class="line">- (<span class="keyword">void</span>)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock forURL:(<span class="built_in">NSURL</span> *)url createCallback:(SDWebImageNoParamsBlock)createCallback &#123;</div><div class="line">    <span class="comment">// The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</span></div><div class="line">    <span class="comment">//å¦‚æœURLä¸ºç©ºï¼Œåˆ™æ‰§è¡ŒcompletedBlockå›è°ƒï¼Œå¹¶ç›´æ¥è¿”å›</span></div><div class="line">    <span class="keyword">if</span> (url == <span class="literal">nil</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (completedBlock != <span class="literal">nil</span>) &#123;</div><div class="line">            completedBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">NO</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//æ …æ å‡½æ•°</span></div><div class="line">    dispatch_barrier_sync(<span class="keyword">self</span>.barrierQueue, ^&#123;</div><div class="line">        <span class="built_in">BOOL</span> first = <span class="literal">NO</span>;</div><div class="line">        <span class="comment">//å¦‚æœURLCallbackså­—å…¸ä¸­urlå¯¹åº”çš„æ•°ç»„ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªç©ºçš„å¯å˜æ•°ç»„ï¼Œå¹¶è®¾ç½®firstçš„å€¼ä¸ºYES</span></div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.URLCallbacks[url]) &#123;</div><div class="line">            <span class="keyword">self</span>.URLCallbacks[url] = [<span class="built_in">NSMutableArray</span> new];</div><div class="line">            first = <span class="literal">YES</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Handle single download of simultaneous download request for the same URL</span></div><div class="line">        <span class="comment">// ä¿è¯å¦‚æœç»Ÿä¸€URLæœ‰å¤šä¸ªä¸‹è½½è¯·æ±‚ï¼Œé‚£ä¹ˆåªä¸‹è½½ä¸€æ¬¡</span></div><div class="line">        </div><div class="line">        <span class="comment">//å¾—åˆ°URLCallbackså­—å…¸ä¸­urlå¯¹åº”çš„æ•°ç»„</span></div><div class="line">        <span class="built_in">NSMutableArray</span> *callbacksForURL = <span class="keyword">self</span>.URLCallbacks[url];</div><div class="line">        </div><div class="line">        <span class="comment">//åˆ›å»ºå¯å˜å­—å…¸ï¼Œåœ¨è¯¥å­—å…¸ä¸­å­˜æ”¾progressBlockå’ŒcompletedBlockï¼Œå¹¶æŠŠè¯¥å­—å…¸ä½œä¸ºå…ƒç´ æ·»åŠ åˆ°æ•°ç»„ä¸­ï¼ˆå³urlå¯¹åº”çš„valueï¼‰</span></div><div class="line">        <span class="built_in">NSMutableDictionary</span> *callbacks = [<span class="built_in">NSMutableDictionary</span> new];</div><div class="line">        <span class="keyword">if</span> (progressBlock) callbacks[kProgressCallbackKey] = [progressBlock <span class="keyword">copy</span>];</div><div class="line">        <span class="keyword">if</span> (completedBlock) callbacks[kCompletedCallbackKey] = [completedBlock <span class="keyword">copy</span>];</div><div class="line">        [callbacksForURL addObject:callbacks];</div><div class="line">        <span class="keyword">self</span>.URLCallbacks[url] = callbacksForURL;</div><div class="line"></div><div class="line">        <span class="comment">//å¦‚æœURLCallbackså­—å…¸ä¸­urlå¯¹åº”çš„æ•°ç»„ä¸å­˜åœ¨,é‚£ä¹ˆå°±è°ƒç”¨createCallbackï¼ˆï¼‰</span></div><div class="line">        <span class="keyword">if</span> (first) &#123;</div><div class="line">            createCallback();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>èµ°å®Œä¸Šé¢è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½ç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½èƒ½å’Œå®ƒçš„progressBlockå’ŒcompletedBlockå›è°ƒä¸€ä¸€å¯¹åº”ï¼Œæ¥ç€å›åˆ°<code>download</code>æ–¹æ³•ç»§ç»­çœ‹ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ ¸å¿ƒæ–¹æ³•ï¼šä¸‹è½½å›¾ç‰‡çš„æ“ä½œ</span></div><div class="line"><span class="comment">/*</span></div><div class="line"> * ä½¿ç”¨ç»™å®šçš„ URL åˆ›å»º SDWebImageDownloader å¼‚æ­¥ä¸‹è½½å™¨å®ä¾‹</div><div class="line"> * å›¾åƒä¸‹è½½å®Œæˆæˆ–è€…å‡ºç°é”™è¯¯æ—¶ä¼šé€šçŸ¥ä»£ç†</div><div class="line"> * url:è¦ä¸‹è½½çš„å›¾åƒ URL</div><div class="line"> * SDWebImageDownloaderOptionsï¼šä¸‹è½½é€‰é¡¹|ç­–ç•¥</div><div class="line"> * progressBlockï¼šå›¾åƒä¸‹è½½è¿‡ç¨‹ä¸­è¢«é‡å¤è°ƒç”¨çš„ blockï¼Œç”¨æ¥æŠ¥å‘Šä¸‹è½½è¿›åº¦</div><div class="line"> * completedBlockï¼šå›¾åƒä¸‹è½½å®Œæˆåè¢«è°ƒç”¨ä¸€æ¬¡çš„ block</div><div class="line"> *      image:å¦‚æœä¸‹è½½æˆåŠŸï¼Œimage å‚æ•°ä¼šè¢«è®¾ç½®</div><div class="line"> *      error:å¦‚æœå‡ºç°é”™è¯¯ï¼Œerror å‚æ•°ä¼šè¢«è®¾ç½®</div><div class="line"> *      finished:</div><div class="line"> *      å¦‚æœæ²¡æœ‰ä½¿ç”¨ SDWebImageDownloaderProgressiveDownloadï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸€ç›´æ˜¯ YES</div><div class="line"> *      å¦‚æœä½¿ç”¨äº† SDWebImageDownloaderProgressiveDownload é€‰é¡¹ï¼Œæ­¤ block ä¼šè¢«é‡å¤è°ƒç”¨</div><div class="line"> *      1)ä¸‹è½½å®Œæˆå‰ï¼Œimage å‚æ•°æ˜¯éƒ¨åˆ†å›¾åƒï¼Œfinished å‚æ•°æ˜¯ NO</div><div class="line"> *      2)æœ€åä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œimage å‚æ•°æ˜¯å®Œæ•´å›¾åƒï¼Œè€Œ finished å‚æ•°æ˜¯ YES</div><div class="line"> *      3)å¦‚æœå‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆfinished å‚æ•°ä¹Ÿæ˜¯ YES</div><div class="line"> *  è¿”å›å€¼ï¼šå¯è¢«å–æ¶ˆçš„ SDWebImageOperation</div><div class="line"> */</div><div class="line"></div><div class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="built_in">NSURL</span> *)url options:(SDWebImageDownloaderOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageDownloaderCompletedBlock)completedBlock &#123;</div><div class="line">    __block SDWebImageDownloaderOperation *operation;</div><div class="line">    __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)wself = <span class="keyword">self</span>;  <span class="comment">//ä¸ºäº†é¿å…blockçš„å¾ªç¯å¼•ç”¨</span></div><div class="line"></div><div class="line">    <span class="comment">//å¤„ç†è¿›åº¦å›è°ƒ|å®Œæˆå›è°ƒç­‰ï¼Œå¦‚æœè¯¥urlåœ¨self.URLCallbackså¹¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨createCallback blockå—</span></div><div class="line">    [<span class="keyword">self</span> addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^&#123;</div><div class="line">        </div><div class="line">        <span class="comment">//å¤„ç†ä¸‹è½½è¶…æ—¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¿‡åˆ™åˆå§‹åŒ–ä¸º15ç§’</span></div><div class="line">        <span class="built_in">NSTimeInterval</span> timeoutInterval = wself.downloadTimeout;</div><div class="line">        <span class="keyword">if</span> (timeoutInterval == <span class="number">0.0</span>) &#123;</div><div class="line">            timeoutInterval = <span class="number">15.0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise</span></div><div class="line">        <span class="comment">//æ ¹æ®ç»™å®šçš„URLå’Œç¼“å­˜ç­–ç•¥åˆ›å»ºå¯å˜çš„è¯·æ±‚å¯¹è±¡ï¼Œè®¾ç½®è¯·æ±‚è¶…æ—¶</span></div><div class="line">        <span class="comment">//è¯·æ±‚ç­–ç•¥ï¼šå¦‚æœæ˜¯SDWebImageDownloaderUseNSURLCacheåˆ™ä½¿ç”¨NSURLRequestUseProtocolCachePolicyï¼Œå¦åˆ™ä½¿ç”¨NSURLRequestReloadIgnoringLocalCacheData</span></div><div class="line">        <span class="comment">/*</span></div><div class="line">         NSURLRequestUseProtocolCachePolicy:é»˜è®¤çš„ç¼“å­˜ç­–ç•¥</div><div class="line">            1)å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œç›´æ¥ä»æœåŠ¡ç«¯è·å–ã€‚</div><div class="line">            2)å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œä¼šæ ¹æ®responseä¸­çš„Cache-Controlå­—æ®µåˆ¤æ–­ä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦‚: Cache-Controlå­—æ®µä¸ºmust-revalidata, åˆ™è¯¢é—®æœåŠ¡ç«¯è¯¥æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ï¼Œæ— æ›´æ–°çš„è¯ç›´æ¥è¿”å›ç»™ç”¨æˆ·ç¼“å­˜æ•°æ®ï¼Œè‹¥å·²æ›´æ–°ï¼Œåˆ™è¯·æ±‚æœåŠ¡ç«¯.</div><div class="line">         NSURLRequestReloadIgnoringLocalCacheData:å¿½ç•¥æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œç›´æ¥è¯·æ±‚æœåŠ¡ç«¯ã€‚</div><div class="line">         */</div><div class="line">        <span class="built_in">NSMutableURLRequest</span> *request = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url cachePolicy:(options &amp; SDWebImageDownloaderUseNSURLCache ? <span class="built_in">NSURLRequestUseProtocolCachePolicy</span> : <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span>) timeoutInterval:timeoutInterval];</div><div class="line">        </div><div class="line">        <span class="comment">//è®¾ç½®æ˜¯å¦ä½¿ç”¨Cookies(é‡‡ç”¨æŒ‰ä½ä¸ï¼‰</span></div><div class="line">        <span class="comment">/*</span></div><div class="line">         å…³äºcookieså‚è€ƒï¼šhttp://blog.csdn.net/chun799/article/details/17206907</div><div class="line">         */</div><div class="line">        request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);</div><div class="line">        <span class="comment">//å¼€å¯HTTPç®¡é“ï¼Œè¿™å¯ä»¥æ˜¾è‘—é™ä½è¯·æ±‚çš„åŠ è½½æ—¶é—´ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰è¢«æœåŠ¡å™¨å¹¿æ³›æ”¯æŒï¼Œé»˜è®¤æ˜¯ç¦ç”¨çš„</span></div><div class="line">        request.HTTPShouldUsePipelining = <span class="literal">YES</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//è®¾ç½®è¯·æ±‚å¤´ä¿¡æ¯ï¼ˆè¿‡æ»¤ç­‰ï¼‰</span></div><div class="line">        <span class="keyword">if</span> (wself.headersFilter) &#123;</div><div class="line">            request.allHTTPHeaderFields = wself.headersFilter(url, [wself.HTTPHeaders <span class="keyword">copy</span>]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            request.allHTTPHeaderFields = wself.HTTPHeaders;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//æ ¸å¿ƒæ–¹æ³•ï¼šåˆ›å»ºä¸‹è½½å›¾ç‰‡çš„æ“ä½œ</span></div><div class="line">        operation = [[wself.operationClass alloc] initWithRequest:request options:options progress:^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize) &#123;</div><div class="line">            SDWebImageDownloader *sself = wself;</div><div class="line">            <span class="keyword">if</span> (!sself) <span class="keyword">return</span>;</div><div class="line">            __block <span class="built_in">NSArray</span> *callbacksForURL;</div><div class="line">            <span class="built_in">dispatch_sync</span>(sself.barrierQueue, ^&#123;</div><div class="line">                callbacksForURL = [sself.URLCallbacks[url] <span class="keyword">copy</span>];</div><div class="line">            &#125;);</div><div class="line">            </div><div class="line">            <span class="comment">//éå†callbacksForURLæ•°ç»„ä¸­çš„æ‰€æœ‰å­—å…¸ï¼Œæ‰§è¡ŒSDWebImageDownloaderProgressBlockå›è°ƒ</span></div><div class="line">            <span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *callbacks <span class="keyword">in</span> callbacksForURL) &#123;</div><div class="line">                <span class="comment">//è¯´æ˜ï¼šSDWebImageDownloaderProgressBlockä½œè€…å¯èƒ½è€ƒè™‘åˆ°ç”¨æˆ·æ‹¿åˆ°è¿›åº¦æ•°æ®åä¼šè¿›è¡Œåˆ·æ–°å¤„ç†ï¼Œå› æ­¤åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†äº†å›è°ƒ</span></div><div class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    SDWebImageDownloaderProgressBlock callback = callbacks[kProgressCallbackKey];</div><div class="line">                    <span class="keyword">if</span> (callback) callback(receivedSize, expectedSize);</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125; completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, <span class="built_in">BOOL</span> finished) &#123;</div><div class="line">            SDWebImageDownloader *sself = wself;</div><div class="line">            <span class="keyword">if</span> (!sself) <span class="keyword">return</span>;</div><div class="line">            __block <span class="built_in">NSArray</span> *callbacksForURL;</div><div class="line">            </div><div class="line">            dispatch_barrier_sync(sself.barrierQueue, ^&#123;</div><div class="line">                callbacksForURL = [sself.URLCallbacks[url] <span class="keyword">copy</span>];</div><div class="line">                </div><div class="line">                <span class="comment">//å¦‚æœå®Œæˆï¼Œé‚£ä¹ˆæŠŠURLä»URLCallbackså­—å…¸ä¸­åˆ é™¤</span></div><div class="line">                <span class="keyword">if</span> (finished) &#123;</div><div class="line">                    [sself.URLCallbacks removeObjectForKey:url];</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            </div><div class="line">            <span class="comment">//éå†callbacksForURLæ•°ç»„ä¸­çš„æ‰€æœ‰å­—å…¸ï¼Œæ‰§è¡ŒSDWebImageDownloaderCompletedBlockå›è°ƒ</span></div><div class="line">            <span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *callbacks <span class="keyword">in</span> callbacksForURL) &#123;</div><div class="line">                SDWebImageDownloaderCompletedBlock callback = callbacks[kCompletedCallbackKey];</div><div class="line">                <span class="keyword">if</span> (callback) callback(image, data, error, finished);</div><div class="line">            &#125;</div><div class="line">        &#125; cancelled:^&#123;</div><div class="line">            SDWebImageDownloader *sself = wself;</div><div class="line">            <span class="keyword">if</span> (!sself) <span class="keyword">return</span>;</div><div class="line">            </div><div class="line">            <span class="comment">//æŠŠå½“å‰çš„urlä»URLCallbackså­—å…¸ä¸­ç§»é™¤</span></div><div class="line">            dispatch_barrier_async(sself.barrierQueue, ^&#123;</div><div class="line">                [sself.URLCallbacks removeObjectForKey:url];</div><div class="line">            &#125;);</div><div class="line">        &#125;];</div><div class="line">        <span class="comment">//è®¾ç½®æ˜¯å¦éœ€è¦è§£ç </span></div><div class="line">        operation.shouldDecompressImages = wself.shouldDecompressImages;</div><div class="line">        </div><div class="line">        <span class="comment">//èº«ä»½è®¤è¯</span></div><div class="line">        <span class="keyword">if</span> (wself.urlCredential) &#123;</div><div class="line">            operation.credential = wself.urlCredential;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wself.username &amp;&amp; wself.password) &#123;</div><div class="line">            <span class="comment">//è®¾ç½® https è®¿é—®æ—¶èº«ä»½éªŒè¯ä½¿ç”¨çš„å‡­æ®</span></div><div class="line">            operation.credential = [<span class="built_in">NSURLCredential</span> credentialWithUser:wself.username password:wself.password persistence:<span class="built_in">NSURLCredentialPersistenceForSession</span>];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//åˆ¤æ–­ä¸‹è½½ç­–ç•¥æ˜¯å¦æ˜¯é«˜ä¼˜å…ˆçº§çš„æˆ–ä½ä¼˜å…ˆçº§ï¼Œä»¥è®¾ç½®æ“ä½œçš„é˜Ÿåˆ—ä¼˜å…ˆçº§</span></div><div class="line">        <span class="keyword">if</span> (options &amp; SDWebImageDownloaderHighPriority) &#123;</div><div class="line">            operation.queuePriority = <span class="built_in">NSOperationQueuePriorityHigh</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options &amp; SDWebImageDownloaderLowPriority) &#123;</div><div class="line">            operation.queuePriority = <span class="built_in">NSOperationQueuePriorityLow</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//æŠŠä¸‹è½½æ“ä½œæ·»åŠ åˆ°ä¸‹è½½é˜Ÿåˆ—ä¸­</span></div><div class="line">        <span class="comment">//è¯¥æ–¹æ³•ä¼šè°ƒç”¨operationå†…éƒ¨çš„startæ–¹æ³•å¼€å¯å›¾ç‰‡çš„ä¸‹è½½ä»»åŠ¡</span></div><div class="line">        [wself.downloadQueue addOperation:operation];</div><div class="line">        </div><div class="line">        <span class="comment">//åˆ¤æ–­ä»»åŠ¡çš„æ‰§è¡Œä¼˜å…ˆçº§ï¼Œå¦‚æœæ˜¯åè¿›å…ˆå‡ºï¼Œåˆ™è°ƒæ•´ä»»åŠ¡çš„ä¾èµ–å…³ç³»ï¼Œä¼˜å…ˆæ‰§è¡Œå½“å‰çš„ï¼ˆæœ€åæ·»åŠ ï¼‰ä»»åŠ¡</span></div><div class="line">        <span class="keyword">if</span> (wself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;</div><div class="line">            <span class="comment">// Emulate LIFO execution order by systematically adding new operations as last operation's dependency</span></div><div class="line">            [wself.lastAddedOperation addDependency:operation];</div><div class="line">            </div><div class="line">            wself.lastAddedOperation = operation;<span class="comment">//è®¾ç½®å½“å‰ä¸‹è½½æ“ä½œä¸ºæœ€åä¸€ä¸ªæ“ä½œ</span></div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    <span class="keyword">return</span> operation;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>downloadImageWithURL</code>æ–¹æ³•çš„å†…å®¹ä¸å¤šï¼Œé€šè¿‡ä¸€æ­¥æ­¥çš„æ‹†åˆ†æˆ‘ä»¬å¯ä»¥çœ‹çš„æ¯”è¾ƒæ˜äº†ï¼Œä¸‹é¢ç»§ç»­çœ‹çœ‹<code>SDWebImageDownloaderOperation</code>è¿™ä¸ªç±»ä¸­åšäº†å“ªäº›äº‹æƒ…</p>
<h4 id="SDWebImageDownloaderOperation"><a href="#SDWebImageDownloaderOperation" class="headerlink" title="SDWebImageDownloaderOperation"></a>SDWebImageDownloaderOperation</h4><p><code>SDWebImageDownloaderOperation</code>ç»§æ‰¿äº<code>NSOperation</code>é‡å†™äº†<code>start</code>æ–¹æ³•ï¼Œåœ¨<code>start</code>æ–¹æ³•é‡Œåˆ›å»ºäº†NSURLConnectioné“¾æ¥å¯¹è±¡ã€‚å…ˆçœ‹çœ‹å¯¹å¤–å¼€æ”¾çš„åˆå§‹åŒ–<code>operation</code>æ–¹æ³•åšäº†å“ªäº›å·¥ä½œï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//åˆå§‹åŒ–operationçš„æ–¹æ³•</span></div><div class="line">- (<span class="keyword">id</span>)initWithRequest:(<span class="built_in">NSURLRequest</span> *)request</div><div class="line">              options:(SDWebImageDownloaderOptions)options</div><div class="line">             progress:(SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">            completed:(SDWebImageDownloaderCompletedBlock)completedBlock</div><div class="line">            cancelled:(SDWebImageNoParamsBlock)cancelBlock &#123;</div><div class="line">    <span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</div><div class="line">        _request = request; <span class="comment">//åœ¨SDWebImageDownloaderä¸­åˆ›å»ºçš„NSMutableURLRequestå¯¹è±¡</span></div><div class="line">        _shouldDecompressImages = <span class="literal">YES</span>; <span class="comment">//æ˜¯å¦è§£å›¾ç‰‡</span></div><div class="line">        _shouldUseCredentialStorage = <span class="literal">YES</span>; <span class="comment">//URL è¿æ¥æ˜¯å¦è¯¢é—®ä¿å­˜è¿æ¥èº«ä»½éªŒè¯çš„å‡­æ®ï¼Œé»˜è®¤æ˜¯ `YES</span></div><div class="line">        _options = options; <span class="comment">//ä¸‹è½½ç­–ç•¥</span></div><div class="line">        _progressBlock = [progressBlock <span class="keyword">copy</span>]; <span class="comment">//è¿›åº¦å›è°ƒ</span></div><div class="line">        _completedBlock = [completedBlock <span class="keyword">copy</span>]; <span class="comment">//ä¸‹è½½å®Œæˆå›è°ƒ</span></div><div class="line">        _cancelBlock = [cancelBlock <span class="keyword">copy</span>]; <span class="comment">//å–æ¶ˆå›è°ƒ</span></div><div class="line">        _executing = <span class="literal">NO</span>;</div><div class="line">        _finished = <span class="literal">NO</span>;</div><div class="line">        _expectedSize = <span class="number">0</span>;</div><div class="line">        responseFromCached = <span class="literal">YES</span>; <span class="comment">// Initially wrong until `connection:willCacheResponse:` is called or not called</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åˆå§‹åŒ–ä¸»è¦è¿˜æ˜¯å¯¹ä¸€äº›å‚æ•°åšäº†é…ç½®ï¼Œä¸‹é¢çœ‹startæ–¹æ³•ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ ¸å¿ƒæ–¹æ³•ï¼šåœ¨è¯¥æ–¹æ³•ä¸­å¤„ç†å›¾ç‰‡ä¸‹è½½æ“ä½œ</span></div><div class="line">- (<span class="keyword">void</span>)start &#123;</div><div class="line">    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="comment">//åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦è¢«å–æ¶ˆï¼Œå¦‚æœè¢«å–æ¶ˆäº†ï¼Œåˆ™æ ‡è®°ä»»åŠ¡ç»“æŸï¼Œå¹¶å¤„ç†åç»­çš„blockå’Œæ¸…ç†æ“ä½œ</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) &#123;</div><div class="line">            <span class="keyword">self</span>.finished = <span class="literal">YES</span>;</div><div class="line">            [<span class="keyword">self</span> reset];</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line"><span class="comment">//å¼€å¯åå°ä¸‹è½½ä»»åŠ¡</span></div><div class="line"><span class="comment">//æ¡ä»¶ç¼–è¯‘ï¼Œå¦‚æœæ˜¯iphoneè®¾å¤‡ä¸”å¤§äº4.0</span></div><div class="line"><span class="meta">#if TARGET_OS_IPHONE &amp;&amp; __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_4_0</span></div><div class="line">        <span class="comment">//å…ˆéªŒè¯UIApplicationå®ä½“æ˜¯å¦å­˜åœ¨</span></div><div class="line">        Class <span class="built_in">UIApplicationClass</span> = <span class="built_in">NSClassFromString</span>(<span class="string">@"UIApplication"</span>);</div><div class="line">        <span class="built_in">BOOL</span> hasApplication = <span class="built_in">UIApplicationClass</span> &amp;&amp; [<span class="built_in">UIApplicationClass</span> respondsToSelector:<span class="keyword">@selector</span>(sharedApplication)];</div><div class="line">       </div><div class="line">        <span class="comment">//å¦‚æœå­˜åœ¨ä¸”å…è®¸åå°ä¸‹è½½</span></div><div class="line">        <span class="keyword">if</span> (hasApplication &amp;&amp; [<span class="keyword">self</span> shouldContinueWhenAppEntersBackground]) &#123;</div><div class="line">            __<span class="keyword">weak</span> __typeof__ (<span class="keyword">self</span>) wself = <span class="keyword">self</span>;</div><div class="line">            </div><div class="line">            <span class="comment">//è·å¾—UIApplicationå•ä¾‹å¯¹è±¡</span></div><div class="line">            <span class="built_in">UIApplication</span> * app = [<span class="built_in">UIApplicationClass</span> performSelector:<span class="keyword">@selector</span>(sharedApplication)];</div><div class="line">            </div><div class="line">            <span class="comment">//UIBackgroundTaskIdentifierï¼šé€šè¿‡UIBackgroundTaskIdentifierå¯ä»¥å®ç°æœ‰é™æ—¶é—´å†…åœ¨åå°è¿è¡Œç¨‹åº</span></div><div class="line">            <span class="comment">//åœ¨åå°è·å–ä¸€å®šçš„æ—¶é—´å»æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç </span></div><div class="line">            <span class="keyword">self</span>.backgroundTaskId = [app beginBackgroundTaskWithExpirationHandler:^&#123;</div><div class="line">                <span class="comment">//è¿™ä¸ªå›è°ƒæ˜¯åå°ä»»åŠ¡å°†è¢«ç³»ç»Ÿæ€æ­»æ—¶æ‰§è¡Œï¼Œè¿™é‡Œå–æ¶ˆäº†ä¸‹è½½ä»»åŠ¡</span></div><div class="line">                __<span class="keyword">strong</span> __<span class="keyword">typeof</span> (wself) sself = wself;</div><div class="line"></div><div class="line"><span class="meta">#warning 3</span></div><div class="line">                <span class="keyword">if</span> (sself) &#123;</div><div class="line">                    [sself cancel]; <span class="comment">//å–æ¶ˆå½“å‰ä¸‹è½½æ“ä½œ</span></div><div class="line"></div><div class="line">                    [app endBackgroundTask:sself.backgroundTaskId]; <span class="comment">//ç»“æŸåå°ä»»åŠ¡</span></div><div class="line">                    sself.backgroundTaskId = <span class="built_in">UIBackgroundTaskInvalid</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;];</div><div class="line">        &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line">        <span class="comment">//æ„å»ºNSURLConnectionå‘æœåŠ¡å™¨å‘é€è¯·æ±‚(å½“å‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œ)</span></div><div class="line">        <span class="keyword">self</span>.executing = <span class="literal">YES</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//åˆ›å»ºNSURLConnectionå¯¹è±¡ï¼Œå¹¶è®¾ç½®ä»£ç†ï¼ˆæ²¡æœ‰é©¬ä¸Šå‘é€è¯·æ±‚ï¼‰</span></div><div class="line">        <span class="keyword">self</span>.connection = [[<span class="built_in">NSURLConnection</span> alloc] initWithRequest:<span class="keyword">self</span>.request delegate:<span class="keyword">self</span> startImmediately:<span class="literal">NO</span>];</div><div class="line">        </div><div class="line">        <span class="comment">//è·å¾—å½“å‰çº¿ç¨‹</span></div><div class="line">        <span class="keyword">self</span>.thread = [<span class="built_in">NSThread</span> currentThread];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [<span class="keyword">self</span>.connection start];    <span class="comment">//å‘é€ç½‘ç»œè¯·æ±‚</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.connection) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.progressBlock) &#123;</div><div class="line">            <span class="comment">//è¿›åº¦blockçš„å›è°ƒ</span></div><div class="line">            <span class="keyword">self</span>.progressBlock(<span class="number">0</span>, <span class="built_in">NSURLResponseUnknownLength</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//æ³¨å†Œé€šçŸ¥ä¸­å¿ƒï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­å‘é€é€šçŸ¥SDWebImageDownloadStartNotificationã€ä»»åŠ¡å¼€å§‹ä¸‹è½½ã€‘</span></div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">            [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:SDWebImageDownloadStartNotification object:<span class="keyword">self</span>];</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">//éœ€è¦æ‰‹åŠ¨å¼€å¯çº¿ç¨‹å¯¹åº”çš„Runloop,connectionæ‰èƒ½æ­£å¸¸æ¥æ”¶delegateå›è°ƒ</span></div><div class="line">        <span class="keyword">if</span> (floor(<span class="built_in">NSFoundationVersionNumber</span>) &lt;= <span class="built_in">NSFoundationVersionNumber_iOS_5_1</span>) &#123;</div><div class="line">            <span class="comment">// Make sure to run the runloop in our background thread so it can process downloaded data</span></div><div class="line">            <span class="comment">//ç¡®ä¿åå°çº¿ç¨‹çš„runloopè·‘èµ·æ¥</span></div><div class="line">            <span class="comment">// Note: we use a timeout to work around an issue with NSURLConnection cancel under iOS 5</span></div><div class="line">            <span class="comment">//       not waking up the runloop, leading to dead threads (see https://github.com/rs/SDWebImage/issues/466)</span></div><div class="line">            <span class="built_in">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, <span class="number">10</span>, <span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//å¼€å¯Runloop</span></div><div class="line">            <span class="built_in">CFRunLoopRun</span>();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//runloopå…³é—­ä¹‹åæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç </span></div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.isFinished) &#123;</div><div class="line">            [<span class="keyword">self</span>.connection cancel];  <span class="comment">//è¯·æ±‚å¤±è´¥(å–æ¶ˆç½‘ç»œè¿æ¥)</span></div><div class="line">            <span class="comment">//å¤„ç†é”™è¯¯ä¿¡æ¯</span></div><div class="line">            [<span class="keyword">self</span> connection:<span class="keyword">self</span>.connection didFailWithError:[<span class="built_in">NSError</span> errorWithDomain:<span class="built_in">NSURLErrorDomain</span> code:<span class="built_in">NSURLErrorTimedOut</span> userInfo:@&#123;<span class="built_in">NSURLErrorFailingURLErrorKey</span> : <span class="keyword">self</span>.request.URL&#125;]];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//NSURLConnectionåˆå§‹åŒ–å¤±è´¥ï¼Œæ‰§è¡ŒcompletedBlockå›è°ƒ</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.completedBlock) &#123;</div><div class="line">            <span class="keyword">self</span>.completedBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, [<span class="built_in">NSError</span> errorWithDomain:<span class="built_in">NSURLErrorDomain</span> code:<span class="number">0</span> userInfo:@&#123;<span class="built_in">NSLocalizedDescriptionKey</span> : <span class="string">@"Connection can't be initialized"</span>&#125;], <span class="literal">YES</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//åˆ°è¿™é‡Œï¼Œä¸ç®¡ä¸‹è½½æˆåŠŸä¸å¦ï¼Œéƒ½æ³¨é”€ä¹‹å‰æ³¨å†Œçš„åå°ä»»åŠ¡</span></div><div class="line"><span class="meta">#if TARGET_OS_IPHONE &amp;&amp; __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_4_0</span></div><div class="line">    Class <span class="built_in">UIApplicationClass</span> = <span class="built_in">NSClassFromString</span>(<span class="string">@"UIApplication"</span>);</div><div class="line">    <span class="keyword">if</span>(!<span class="built_in">UIApplicationClass</span> || ![<span class="built_in">UIApplicationClass</span> respondsToSelector:<span class="keyword">@selector</span>(sharedApplication)]) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.backgroundTaskId != <span class="built_in">UIBackgroundTaskInvalid</span>) &#123;</div><div class="line">        <span class="built_in">UIApplication</span> * app = [<span class="built_in">UIApplication</span> performSelector:<span class="keyword">@selector</span>(sharedApplication)];</div><div class="line">        [app endBackgroundTask:<span class="keyword">self</span>.backgroundTaskId];</div><div class="line">        <span class="keyword">self</span>.backgroundTaskId = <span class="built_in">UIBackgroundTaskInvalid</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>start æ–¹æ³•æ˜¯å®ç°å¹¶å‘NSOperationçš„æ ¸å¿ƒæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œåˆ›å»ºäº†NSURLConnectionè¯·æ±‚å¹¶å‘èµ·è¯·æ±‚ã€‚<br>å†é‡ç‚¹çœ‹ä¸‹ <code>NSURLConnection</code>çš„ä¸¤ä¸ªä»£ç†æ–¹æ³•ï¼š</p>
<p>å½“æ¥æ”¶åˆ°æœåŠ¡å™¨è¿”å›æ•°æ®çš„æ—¶å€™è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¯èƒ½ä¼šè°ƒç”¨å¤šæ¬¡<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å½“æ¥æ”¶åˆ°æœåŠ¡å™¨è¿”å›æ•°æ®çš„æ—¶å€™è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¯èƒ½ä¼šè°ƒç”¨å¤šæ¬¡</span></div><div class="line">- (<span class="keyword">void</span>)connection:(<span class="built_in">NSURLConnection</span> *)connection didReceiveData:(<span class="built_in">NSData</span> *)data &#123;</div><div class="line">    <span class="comment">//ä¸æ–­æ‹¼æ¥æ¥æ”¶åˆ°çš„å›¾ç‰‡æ•°æ®ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰</span></div><div class="line">    [<span class="keyword">self</span>.imageData appendData:data];</div><div class="line"></div><div class="line">    <span class="comment">//å¦‚æœä¸‹è½½å›¾ç‰‡è®¾ç½®çš„ç­–ç•¥æ˜¯optionså€¼ä¸º SDWebImageDownloaderProgressiveDownload</span></div><div class="line">    <span class="comment">//å³è¾¹ä¸‹è½½è¾¹æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯ä¸‹è½½å®Œæˆä¸€æ¬¡æ´—æ˜¾ç¤ºï¼Œåˆ™éœ€è¦éšç€æ¥æ”¶åˆ°dataæ•°æ®ç«‹å³è¿›è¡Œå›¾ç‰‡è½¬åŒ–ã€‚</span></div><div class="line">    <span class="keyword">if</span> ((<span class="keyword">self</span>.options &amp; SDWebImageDownloaderProgressiveDownload) &amp;&amp; <span class="keyword">self</span>.expectedSize &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">self</span>.completedBlock) &#123;</div><div class="line">        <span class="comment">// The following code is from http://www.cocoaintheshell.com/2011/05/progressive-images-download-imageio/</span></div><div class="line">        <span class="comment">// Thanks to the author @Nyx0uf</span></div><div class="line"></div><div class="line">        <span class="comment">// Get the total bytes downloaded</span></div><div class="line">        <span class="comment">//è·å¾—å½“å‰å·²ç»æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ•°æ®å¤§å°</span></div><div class="line">        <span class="keyword">const</span> <span class="built_in">NSInteger</span> totalSize = <span class="keyword">self</span>.imageData.length;</div><div class="line"></div><div class="line">        <span class="comment">// Update the data source, we must pass ALL the data, not just the new bytes</span></div><div class="line">        <span class="comment">// æŠŠå›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºCGImageSourceRef</span></div><div class="line">        <span class="built_in">CGImageSourceRef</span> imageSource = <span class="built_in">CGImageSourceCreateWithData</span>((__bridge <span class="built_in">CFDataRef</span>)<span class="keyword">self</span>.imageData, <span class="literal">NULL</span>);</div><div class="line">        </div><div class="line">        <span class="comment">//å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼ˆå³æ¥æ”¶åˆ°ç¬¬ä¸€éƒ¨åˆ†çš„å›¾ç‰‡æ•°æ®ï¼‰</span></div><div class="line">        <span class="keyword">if</span> (width + height == <span class="number">0</span>) &#123;</div><div class="line">            <span class="built_in">CFDictionaryRef</span> properties = <span class="built_in">CGImageSourceCopyPropertiesAtIndex</span>(imageSource, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">            <span class="keyword">if</span> (properties) &#123;</div><div class="line">                <span class="built_in">NSInteger</span> orientationValue = <span class="number">-1</span>;</div><div class="line">                <span class="built_in">CFTypeRef</span> val = <span class="built_in">CFDictionaryGetValue</span>(properties, kCGImagePropertyPixelHeight);</div><div class="line">                <span class="keyword">if</span> (val) <span class="built_in">CFNumberGetValue</span>(val, kCFNumberLongType, &amp;height);</div><div class="line">                val = <span class="built_in">CFDictionaryGetValue</span>(properties, kCGImagePropertyPixelWidth);</div><div class="line">                <span class="keyword">if</span> (val) <span class="built_in">CFNumberGetValue</span>(val, kCFNumberLongType, &amp;width);</div><div class="line">                val = <span class="built_in">CFDictionaryGetValue</span>(properties, kCGImagePropertyOrientation);</div><div class="line">                <span class="keyword">if</span> (val) <span class="built_in">CFNumberGetValue</span>(val, kCFNumberNSIntegerType, &amp;orientationValue);</div><div class="line">                <span class="built_in">CFRelease</span>(properties);</div><div class="line"></div><div class="line">                <span class="comment">// When we draw to Core Graphics, we lose orientation information,</span></div><div class="line">                <span class="comment">// which means the image below born of initWithCGIImage will be</span></div><div class="line">                <span class="comment">// oriented incorrectly sometimes. (Unlike the image born of initWithData</span></div><div class="line">                <span class="comment">// in connectionDidFinishLoading.) So save it here and pass it on later.</span></div><div class="line">                orientation = [[<span class="keyword">self</span> <span class="keyword">class</span>] orientationFromPropertyValue:(orientationValue == <span class="number">-1</span> ? <span class="number">1</span> : orientationValue)];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//æ¥æ”¶æ•°æ®ä¸­æœŸï¼ˆä¹‹å‰æ¥æ”¶è¿‡ä¸€éƒ¨åˆ†ï¼Œä½†ä¸ºå®Œå…¨ï¼‰</span></div><div class="line">        <span class="keyword">if</span> (width + height &gt; <span class="number">0</span> &amp;&amp; totalSize &lt; <span class="keyword">self</span>.expectedSize) &#123;</div><div class="line">            <span class="comment">// Create the image</span></div><div class="line">            <span class="built_in">CGImageRef</span> partialImageRef = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(imageSource, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line"><span class="meta">#ifdef TARGET_OS_IPHONE</span></div><div class="line">            <span class="comment">// Workaround for iOS anamorphic image</span></div><div class="line">            <span class="keyword">if</span> (partialImageRef) &#123;</div><div class="line">                <span class="keyword">const</span> size_t partialHeight = <span class="built_in">CGImageGetHeight</span>(partialImageRef);</div><div class="line">                <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</div><div class="line">                <span class="built_in">CGContextRef</span> bmContext = <span class="built_in">CGBitmapContextCreate</span>(<span class="literal">NULL</span>, width, height, <span class="number">8</span>, width * <span class="number">4</span>, colorSpace, kCGBitmapByteOrderDefault | kCGImageAlphaPremultipliedFirst);</div><div class="line">                <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</div><div class="line">                <span class="keyword">if</span> (bmContext) &#123;</div><div class="line">                    <span class="built_in">CGContextDrawImage</span>(bmContext, (<span class="built_in">CGRect</span>)&#123;.origin.x = <span class="number">0.0</span>f, .origin.y = <span class="number">0.0</span>f, .size.width = width, .size.height = partialHeight&#125;, partialImageRef);</div><div class="line">                    <span class="built_in">CGImageRelease</span>(partialImageRef);</div><div class="line">                    partialImageRef = <span class="built_in">CGBitmapContextCreateImage</span>(bmContext);</div><div class="line">                    <span class="built_in">CGContextRelease</span>(bmContext);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="built_in">CGImageRelease</span>(partialImageRef);</div><div class="line">                    partialImageRef = <span class="literal">nil</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span> (partialImageRef) &#123;</div><div class="line">                <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithCGImage:partialImageRef scale:<span class="number">1</span> orientation:orientation];</div><div class="line">                <span class="built_in">NSString</span> *key = [[SDWebImageManager sharedManager] cacheKeyForURL:<span class="keyword">self</span>.request.URL];</div><div class="line">                <span class="built_in">UIImage</span> *scaledImage = [<span class="keyword">self</span> scaledImageForKey:key image:image];</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.shouldDecompressImages) &#123;</div><div class="line">                    image = [<span class="built_in">UIImage</span> decodedImageWithImage:scaledImage];</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    image = scaledImage;</div><div class="line">                &#125;</div><div class="line">                <span class="built_in">CGImageRelease</span>(partialImageRef);</div><div class="line">                dispatch_main_sync_safe(^&#123;</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">self</span>.completedBlock) &#123;</div><div class="line">                        <span class="keyword">self</span>.completedBlock(image, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">NO</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//é‡Šæ”¾imageSourceå¯¹è±¡</span></div><div class="line">        <span class="built_in">CFRelease</span>(imageSource);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//æ‰§è¡ŒprogressBlockè¿›åº¦å›è°ƒï¼Œä¸æ–­æ›´æ–°è¿›åº¦ä¿¡æ¯</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.progressBlock) &#123;</div><div class="line">        <span class="keyword">self</span>.progressBlock(<span class="keyword">self</span>.imageData.length, <span class="keyword">self</span>.expectedSize);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸‹è½½å®Œæˆçš„ä»£ç†æ–¹æ³•ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å½“è¯·æ±‚ç»“æŸçš„æ—¶å€™ä¼šè°ƒç”¨è¯¥æ–¹æ³•</span></div><div class="line">- (<span class="keyword">void</span>)connectionDidFinishLoading:(<span class="built_in">NSURLConnection</span> *)aConnection &#123;</div><div class="line">    SDWebImageDownloaderCompletedBlock completionBlock = <span class="keyword">self</span>.completedBlock;</div><div class="line">    <span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="comment">//å…³åœå½“å‰çš„runloop é‡Šæ”¾èµ„æº</span></div><div class="line">        <span class="built_in">CFRunLoopStop</span>(<span class="built_in">CFRunLoopGetCurrent</span>());</div><div class="line">        <span class="comment">//æŠŠçº¿ç¨‹å’Œè¿æ¥å¯¹è±¡æ¸…ç©º</span></div><div class="line">        <span class="keyword">self</span>.thread = <span class="literal">nil</span>;</div><div class="line">        <span class="keyword">self</span>.connection = <span class="literal">nil</span>;</div><div class="line">        <span class="comment">//åœ¨ä¸»çº¿ç¨‹ä¸­å‘å‡ºé€šçŸ¥ï¼š</span></div><div class="line">        <span class="comment">//SDWebImageDownloadStopNotification    ä»»åŠ¡åœæ­¢</span></div><div class="line">        <span class="comment">//SDWebImageDownloadFinishNotification  ä»»åŠ¡å®Œæˆ</span></div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">            [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:SDWebImageDownloadStopNotification object:<span class="keyword">self</span>];</div><div class="line">            [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:SDWebImageDownloadFinishNotification object:<span class="keyword">self</span>];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="meta">#warning 5</span></div><div class="line">    <span class="comment">//è¯·æ±‚å¤´æ˜¯å¦æ˜¯ä»ç¼“å­˜è·å–ï¼Ÿ</span></div><div class="line">    <span class="keyword">if</span> (![[<span class="built_in">NSURLCache</span> sharedURLCache] cachedResponseForRequest:_request]) &#123;</div><div class="line">        responseFromCached = <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (completionBlock) &#123;</div><div class="line">        <span class="comment">//å¦‚æœä¸‹è½½ç­–ç•¥optionsæ˜¯SDWebImageDownloaderIgnoreCachedResponse&amp;&amp;responseFromCachedä¸ºçœŸï¼Œæ‰§è¡ŒcompletionBlock æˆåŠŸå›è°ƒ</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.options &amp; SDWebImageDownloaderIgnoreCachedResponse &amp;&amp; responseFromCached) &#123;</div><div class="line">            completionBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">YES</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.imageData) &#123;</div><div class="line">            <span class="comment">//å¦‚æœå¾—åˆ°å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®</span></div><div class="line">            <span class="comment">//æŠŠäºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºå›¾ç‰‡</span></div><div class="line">            <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> sd_imageWithData:<span class="keyword">self</span>.imageData];</div><div class="line">            <span class="comment">//è¿”å›æŒ‡å®šURLçš„ç¼“å­˜é”®å€¼,å³URLå­—ç¬¦ä¸²</span></div><div class="line">            <span class="built_in">NSString</span> *key = [[SDWebImageManager sharedManager] cacheKeyForURL:<span class="keyword">self</span>.request.URL];</div><div class="line">            <span class="comment">//æ ¹æ®æ‰‹æœºå±å¹•åˆ†è¾¨ç‡å¯¹å›¾ç‰‡è¿›è¡Œç¼©æ”¾</span></div><div class="line">            image = [<span class="keyword">self</span> scaledImageForKey:key image:image];</div><div class="line">            </div><div class="line">            <span class="comment">// Do not force decoding animated GIFs</span></div><div class="line">            <span class="comment">//å¦‚æœä¸æ˜¯gifå›¾ï¼Œè§£å‹å›¾ç‰‡</span></div><div class="line">            <span class="keyword">if</span> (!image.images) &#123;</div><div class="line">                <span class="comment">//å¦‚æœéœ€è¦ï¼Œé‚£ä¹ˆå¯¹å›¾ç‰‡è¿›è¡Œè§£å‹ç¼©å¤„ç†</span></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.shouldDecompressImages) &#123;</div><div class="line">                    image = [<span class="built_in">UIImage</span> decodedImageWithImage:image];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//å¦‚æœå‘ç°è½¬æ¢ä¹‹åå›¾ç‰‡çš„Sizeä¸º0ï¼Œåˆ™æ‰§è¡ŒcompletionBlockæˆåŠŸå›è°ƒï¼Œå›¾ç‰‡å‚æ•°ä¼ nilå¹¶æŠ¥é”™</span></div><div class="line">            <span class="keyword">if</span> (<span class="built_in">CGSizeEqualToSize</span>(image.size, <span class="built_in">CGSizeZero</span>)) &#123;</div><div class="line">                completionBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, [<span class="built_in">NSError</span> errorWithDomain:SDWebImageErrorDomain code:<span class="number">0</span> userInfo:@&#123;<span class="built_in">NSLocalizedDescriptionKey</span> : <span class="string">@"Downloaded image has 0 pixels"</span>&#125;], <span class="literal">YES</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                completionBlock(image, <span class="keyword">self</span>.imageData, <span class="literal">nil</span>, <span class="literal">YES</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            completionBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, [<span class="built_in">NSError</span> errorWithDomain:SDWebImageErrorDomain code:<span class="number">0</span> userInfo:@&#123;<span class="built_in">NSLocalizedDescriptionKey</span> : <span class="string">@"Image data is nil"</span>&#125;], <span class="literal">YES</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//é‡Šæ”¾èµ„æº</span></div><div class="line">    <span class="keyword">self</span>.completionBlock = <span class="literal">nil</span>;</div><div class="line">    [<span class="keyword">self</span> done]; <span class="comment">//ç»“æŸåçš„å¤„ç†</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>SDWebImage </strong>â€”â€”<strong>çŸ¥å…¶ç„¶</strong>äº¦çŸ¥å…¶æ‰€ä»¥ç„¶</p>
<h4 id="ä¸‹è½½å›¾ç‰‡çš„æ ¸å¿ƒæ–¹æ³•ä½¿ç”¨"><a href="#ä¸‹è½½å›¾ç‰‡çš„æ ¸å¿ƒæ–¹æ³•ä½¿ç”¨" class="headerlink" title="ä¸‹è½½å›¾ç‰‡çš„æ ¸å¿ƒæ–¹æ³•ä½¿ç”¨"></a>ä¸‹è½½å›¾ç‰‡çš„æ ¸å¿ƒæ–¹æ³•ä½¿ç”¨</h4><p><code>#import &quot;SDWebImageDownloader.h&quot;</code><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * ä½¿ç”¨ç»™å®šçš„ URL åˆ›å»º SDWebImageDownloader å¼‚æ­¥ä¸‹è½½å™¨å®ä¾‹</div><div class="line"> *</div><div class="line"> * @param url å›¾ç‰‡çš„URLåœ°å€</div><div class="line"> * @param options å›¾ç‰‡ä¸‹è½½é€‰é¡¹ï¼ˆç­–ç•¥ï¼‰,å‚è€ƒSDWebImageOptionsçš„æšä¸¾å€¼</div><div class="line"> * @param progressBlock ä¸‹è½½è¿›åº¦å›è°ƒ</div><div class="line"> *        receivedSize å·²ç»ä¸‹è½½çš„æ•°æ®å¤§å°</div><div class="line"> *        expectedSize è¦ä¸‹è½½å›¾ç‰‡çš„æ€»å¤§å°</div><div class="line"> * @param completedBlock æ“ä½œæˆåŠŸå›è°ƒå›è°ƒ,è¯¥å›è°ƒæ²¡æœ‰è¿”å›å€¼</div><div class="line"> *        Imageï¼šè¯·æ±‚çš„ UIImageï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œimageå‚æ•°æ˜¯nil</div><div class="line"> *        dataï¼šå›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®</div><div class="line"> *        errorï¼šå¦‚æœå›¾ç‰‡ä¸‹è½½æˆåŠŸåˆ™errorä¸ºnil,å¦åˆ™erroræœ‰å€¼</div><div class="line"> * @param finishedï¼š</div><div class="line"> *        1.å¦‚æœå›¾åƒä¸‹è½½å®Œæˆåˆ™ä¸ºYES</div><div class="line"> *        2.å¦‚æœæ²¡æœ‰ä½¿ç”¨ SDWebImageDownloaderProgressiveDownloadï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸€ç›´æ˜¯ YES</div><div class="line"> *        3.å¦‚æœä½¿ç”¨äº† SDWebImageDownloaderProgressiveDownload é€‰é¡¹ï¼Œæ­¤ block ä¼šè¢«é‡å¤è°ƒç”¨</div><div class="line"> *          1)ä¸‹è½½å®Œæˆå‰ï¼Œimage å‚æ•°æ˜¯éƒ¨åˆ†å›¾åƒï¼Œfinished å‚æ•°æ˜¯ NO</div><div class="line"> *          2)æœ€åä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œimage å‚æ•°æ˜¯å®Œæ•´å›¾åƒï¼Œè€Œ finished å‚æ•°æ˜¯ YES</div><div class="line"> *          3)å¦‚æœå‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆfinished å‚æ•°ä¹Ÿæ˜¯ YES</div><div class="line"> *</div><div class="line"> * @return è¿”å›å€¼ï¼šå¯è¢«å–æ¶ˆçš„ SDWebImageOperation</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)download3 &#123;</div><div class="line">    [[SDWebImageDownloader sharedDownloader] downloadImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://img4.duitang.com/uploads/blog/201310/18/20131018213446_smUw4.thumb.600_0.jpeg"</span>] options:<span class="number">0</span> progress:^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize) &#123; </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%f"</span>,<span class="number">1.0</span> * receivedSize / expectedSize);</div><div class="line">    &#125; completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, <span class="built_in">BOOL</span> finished) &#123;</div><div class="line">        <span class="comment">/** æ³¨æ„:completedå®Œæˆåè¿™é‡Œæ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ */</span></div><div class="line">        <span class="comment">// çº¿ç¨‹é—´é€šä¿¡(å›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UI)</span></div><div class="line">        [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;</div><div class="line">            <span class="keyword">self</span>.imageView.image = image;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"download3--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        &#125;];</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°è¾“å‡ºæ•ˆæœ<br><img src="http://upload-images.jianshu.io/upload_images/2230763-12d6dbccc3bbf70c.gif?imageMogr2/auto-orient/strip" alt="SDWebImageDownloader æ— å†…å­˜ç¼“å­˜&amp;ç£ç›˜ç¼“å­˜.gif"></p>
<p><strong>åº”ç”¨åœºæ™¯:</strong><br>ä¸éœ€è¦ä»»ä½•çš„ç¼“å­˜å¤„ç†çš„æ—¶å€™ï¼Œ<br>è¯¥æ–¹æ³•æ²¡æœ‰åšä»»ä½•ç¼“å­˜å¤„ç†ã€‚<br><strong>æ³¨æ„ï¼š</strong>è¯¥æ–¹æ³•<code>completed</code>å®Œæˆåè¿™é‡ŒBlockæ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚è¿™é‡Œè¦è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ï¼Œä¸ç„¶ä¼šæœ‰è­¦å‘Šã€‚</p>
<hr>
<p>è¿™ä¸ªæ¡†æ¶æœ‰å¤ªå¤šçš„ä¸œè¥¿å€¼å¾—æˆ‘ä»¬å»å­¦ä¹ æ¨æ•²ï¼Œæ–¹æ–¹é¢é¢éƒ½é€éœ²ç€ä½œè€…ä»¥åŠä¼—å¤šè´¡çŒ®è€…çš„æ™ºæ…§ï¼Œæˆ‘ä»¬è¯»èµ·æ¥ä¹Ÿä¸€å®šä¼šå—ç›Šè‰¯å¤šã€‚</p>
<h4 id="æœŸå¾…"><a href="#æœŸå¾…" class="headerlink" title="æœŸå¾…"></a>æœŸå¾…</h4><hr>
<ul>
<li><p>å¦‚æœåœ¨é˜…è¯»è¿‡ç¨‹ä¸­é‡åˆ° error || new ideasï¼Œå¸Œæœ›ä½ èƒ½ messages æˆ‘ï¼Œæˆ‘ä¼šåŠæ—¶æ”¹æ­£è°¢è°¢ã€‚</p>
</li>
<li><p>å¯¹è¯¥æ¨¡å—<a href="https://github.com/CustomPBWaters/Framework-Annotations-Tools/blob/master/æ”¶å½•%20%26%20æŠ•ç¨¿é¡»çŸ¥.md" target="_blank" rel="external">æˆ‘ä¼š</a> ä¸å®šæ—¶ã€æŒç»­ã€æ›´æ–°ä¸€äº› å­¦ä¹ å¿ƒå¾—ä¸æ–‡ç« ã€å®ç”¨æ‰æ˜¯ç¡¬é“ç† ^_^. ã€‚</p>
</li>
<li><p>ç‚¹å‡»å³ä¸Šè§’çš„ å–œæ¬¢ å’Œ è®¢é˜…Rss æŒ‰é’®ï¼Œå¯ä»¥æ”¶è—æœ¬ä»“åº“ï¼Œå¹¶åœ¨ Demo æ›´æ–°æ—¶æ”¶åˆ°é‚®ä»¶é€šçŸ¥ã€‚</p>
</li>
</ul>

      
    </div>


    <noscript>æ·»åŠ â€œæœ¬æ–‡ç»“æŸâ€æ ‡è®°</noscript>
    <div>
      
        

<div style="text-align:center; color:#ccc; font-size:16px; ">
 â„ï¸  æœ¬æ–‡ç»“æŸ
 &nbsp;<i class="fa fa-coffee"></i>&nbsp; 
 æ„Ÿè°¢é˜…è¯» ^_^.  â„ï¸   
</div>

<div style="text-align:center; color:#ccc; font-size:16px; ">
 ğŸ‘ At this time suggest 1 minute eye exercises 
</div>




      
    </div>
    <noscript>æ·»åŠ â€œæœ¬æ–‡ç»“æŸâ€æ ‡è®°</noscript>


 

    <noscript>ç‰ˆæƒ</noscript>
    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JSåº“ sweetalert å¯ä¿®æ”¹è·¯å¾„ -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">
  <p><span>æœ¬æ–‡æ ‡é¢˜:</span><a href="/SourceAnnotations/SDSourceCode3.html">SDWebImageæºç 3â€”SDWebImageDownloader</a></p>
  <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="è®¿é—® æ— å‘³sh çš„ä¸ªäººåšå®¢">æ— å‘³sh</a></p>
  <p><span>åŸå§‹é“¾æ¥:</span><a href="/SourceAnnotations/SDSourceCode3.html" title="SDWebImageæºç 3â€”SDWebImageDownloader">https://sunyonghui.github.io/SourceAnnotations/SDSourceCode3.html</a>
    <span class="copy-path"  title="ç‚¹å‡»å¤åˆ¶æ–‡ç« é“¾æ¥"><i class="fa fa-clipboard" data-clipboard-text="https://sunyonghui.github.io/SourceAnnotations/SDSourceCode3.html"  aria-label="å¤åˆ¶æˆåŠŸï¼"></i></span>
  </p>
  <p><span>ç‰ˆæƒå£°æ˜:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–å‡ä¸ºåŸåˆ›ï¼Œè½¬è½½è¯·åœ¨æ–‡ç« å¼€å¤´ä½ç½®æ³¨æ˜æ ¼å¼ã€ŒåŸæ–‡é“¾æ¥ - ä½œè€… - ä¿®æ”¹(å¦‚æœ‰æŒ‡å‡ºæŸéƒ¨åˆ†)ã€ï¼Œå¹¶é€šè¿‡E-mailç­‰æ–¹å¼å‘ŠçŸ¥ï¼Œè°¢è°¢åˆä½œï¼</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({   
          title: "",   
          text: 'å¤åˆ¶æˆåŠŸ',   
          html: false,
          timer: 500,   
          showConfirmButton: false
        });
      });
    }));  
</script>

 
      
    </div>
    <noscript>ç‰ˆæƒ</noscript>


    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>ã€Œæ”¯æŒä¸è¦è¶…è¿‡ä½ æ—©é¤è´¹çš„ 0.5ã€ ^_^.</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>èµ</span>
    </button>
    <div id="QR" style="display: none;">
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/uploads/money/alipay.jpg" alt="æ— å‘³sh Alipay"/>
          <p>æ”¯Â·èµèµ</p>
        </div>
      

    </div>
  </div>


      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/æºç /" rel="tag"> <i class="fa fa-tag"></i> æºç </a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/SourceAnnotations/SDSourceCode1.html" rel="next" title="SDWebImageæºç 1â€”SDWebImageManager">
                <i class="fa fa-chevron-left"></i> SDWebImageæºç 1â€”SDWebImageManager
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/iOSNET/NSURLSession.html" rel="prev" title="iOS ç½‘ç»œè¯·æ±‚â€”ã€ŒNSURLSessionä¼šè¯ã€">
                iOS ç½‘ç»œè¯·æ±‚â€”ã€ŒNSURLSessionä¼šè¯ã€ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



 
    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_copy"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:true
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->
 
      
    </div>



  </div>


          </div>
	  
  <div class="comments" id="comments">


    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTk5My82NTU4"></div>




    
 

  </div>







          


          
        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="æ— å‘³sh" />
          <p class="site-author-name" itemprop="name">æ— å‘³sh</p>
          <p class="site-description motion-element" itemprop="description">å¾è¡Œå››æ—¶äº”å‘³ï¼Œå†·æš–ä½ æˆ‘è‡ªçŸ¥.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">55</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
	    <a title="æ­¤æ—¶ï¼Œéœ€è¦å–ç‚¹ç™½å¼€æ°´å—ï¼Ÿ" rel="alternate" class="mw-harlem_shake_slow wobble shake" href='javascript:(
    /*
     * Copyright (C) 2015 Rocko (rocko.xyz) <rocko.zxp@gmail.com>
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.

     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
    function go() {

      var songs = [
          "http://m2.music.126.net/NnHwR2HV-1OoKZ6R5LVy4Q==/18502581673300023.mp3",
          "http://m2.music.126.net/qv3RI4K7ABKJ0TyAdb3taw==/3250156397064860.mp3",    
      ];

      function S() {
          var e = document.getElementById("audio_element_id");
          if(e != null){
              var index = parseInt(e.getAttribute("curSongIndex"));
              if(index > songs.length - 2) {
                  index = 0;
              } else {
                  index++;
              }
              e.setAttribute("curSongIndex", index);
          }
          e.src = i;
          e.play()
      }
      function initAudioEle() {
          var e = document.getElementById("audio_element_id");
          if(e === null){
            e = document.createElement("audio");
            e.setAttribute("curSongIndex", 0);
            e.id = "audio_element_id";
            e.loop = false;
            e.bgcolor = 0;
            e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
            document.body.appendChild(e);
            e.addEventListener("ended", function() {
              go();
            }, true);
          }        
      }

      initAudioEle();
      var curSongIndex = parseInt(document.getElementById("audio_element_id").getAttribute("curSongIndex"));
      var i = songs[curSongIndex];
      S();
    })()'>
    <i class="fa fa-music"></i> Music </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/SunHui-Candy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="ttps://github.com/SunHui-Candy" target="_blank" title="GitBook">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  GitBook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/ce78ee1f9a89" target="_blank" title="csdn">
                  
                    <i class="fa fa-fw fa-scribd"></i>
                  
                  csdn
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/ce78ee1f9a89" target="_blank" title="ç®€ä¹¦">
                  
                    <i class="fa fa-fw fa-tint"></i>
                  
                  ç®€ä¹¦
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/ce78ee1f9a89" target="_blank" title="æ˜é‡‘">
                  
                    <i class="fa fa-fw fa-tint"></i>
                  
                  æ˜é‡‘
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://plainboiledwaterln.cn/PerceptionWork/appreciates.html" target="_blank" title="èµèµç¯‡">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  èµèµç¯‡
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              æ¬¢è¿å‹é“¾
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jianshu.com/u/ce78ee1f9a89" title="ğŸ’¸Swift-æ— å‘³" target="_blank">ğŸ’¸Swift-æ— å‘³</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Write-in-the-first"><span class="nav-number">1.</span> <span class="nav-text">Write in the first</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SDWebImageDownloader-ä¸­æ ¸å¿ƒæ–¹æ³•ï¼šä¸‹è½½å›¾ç‰‡çš„æ“ä½œ"><span class="nav-number">2.</span> <span class="nav-text">SDWebImageDownloader ä¸­æ ¸å¿ƒæ–¹æ³•ï¼šä¸‹è½½å›¾ç‰‡çš„æ“ä½œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SDWebImageDownloaderOperation"><span class="nav-number">3.</span> <span class="nav-text">SDWebImageDownloaderOperation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸‹è½½å›¾ç‰‡çš„æ ¸å¿ƒæ–¹æ³•ä½¿ç”¨"><span class="nav-number">4.</span> <span class="nav-text">ä¸‹è½½å›¾ç‰‡çš„æ ¸å¿ƒæ–¹æ³•ä½¿ç”¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æœŸå¾…"><span class="nav-number">5.</span> <span class="nav-text">æœŸå¾…</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heartbeat"></i>
  </span>
  
  <span class="author" itemprop="copyrightHolder">Sun Yong Hui </span>
</div>




 
<div class="theme-info">
Sharing allows you to generate new ideas or habits . 
</div>

 

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>




        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span>äºº</span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span>æ¬¡</span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>
	


  <!-- å°çº¢å¿ƒ -->
  <script type="text/javascript" src="/js/src/é¼ æ ‡ç‚¹å‡»æ˜¾ç¤ºçº¢å¿ƒ/love.js"></script>

  <!--å´©æºƒæ¬ºéª—-->
  <script type="text/javascript" src="/js/src/è®¾ç½®åŠ¨æ€title/dytitle.js"></script>




  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>






  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  



  




	



  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  
  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("vQ73vkdAKXGXXozJnRHiP5No-gzGzoHsz", "7EXnLkna8V5gAtDESH5QvILv");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


 

  


</body>
</html>
